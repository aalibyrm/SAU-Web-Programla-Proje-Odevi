@model FitnessCenter.Models.ViewModels.AppointmentCreateViewModel
@{
    ViewData["Title"] = "Yeni Randevu";
}

<div class="page-header">
    <div class="container">
        <h1><i class="bi bi-calendar-plus me-3"></i>Yeni Randevu</h1>
        <p class="text-muted mb-0">Yeni bir randevu oluşturun</p>
    </div>
</div>

<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <form asp-action="Create" method="post" id="appointmentForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                        
                        <div class="mb-4">
                            <label asp-for="TrainerId" class="form-label fw-bold">
                                <i class="bi bi-person me-2"></i>Antrenör Seçin
                            </label>
                            <select asp-for="TrainerId" asp-items="Model.Trainers" class="form-select" id="trainerSelect">
                                <option value="">-- Antrenör Seçin --</option>
                            </select>
                            <span asp-validation-for="TrainerId" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-4">
                            <label asp-for="ServiceId" class="form-label fw-bold">
                                <i class="bi bi-grid me-2"></i>Hizmet Seçin
                            </label>
                            <select asp-for="ServiceId" asp-items="Model.Services" class="form-select" id="serviceSelect">
                                <option value="">-- Hizmet Seçin --</option>
                            </select>
                            <span asp-validation-for="ServiceId" class="text-danger"></span>
                            <div id="serviceInfo" class="mt-2 text-muted small"></div>
                        </div>
                        
                        <div class="mb-4">
                            <label asp-for="AppointmentDate" class="form-label fw-bold">
                                <i class="bi bi-calendar me-2"></i>Tarih Seçin
                            </label>
                            <input asp-for="AppointmentDate" type="date" class="form-control" id="dateSelect" 
                                   min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" />
                            <span asp-validation-for="AppointmentDate" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-4">
                            <label asp-for="StartTime" class="form-label fw-bold">
                                <i class="bi bi-clock me-2"></i>Saat Seçin
                            </label>
                            <select asp-for="StartTime" class="form-select" id="timeSelect">
                                <option value="">-- Önce tarih ve antrenör seçin --</option>
                            </select>
                            <span asp-validation-for="StartTime" class="text-danger"></span>
                        </div>
                        
                        <div class="mb-4">
                            <label asp-for="Notes" class="form-label fw-bold">
                                <i class="bi bi-chat-dots me-2"></i>Notlar (İsteğe Bağlı)
                            </label>
                            <textarea asp-for="Notes" class="form-control" rows="3" 
                                      placeholder="Eklemek istediğiniz notları yazabilirsiniz..."></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                                <i class="bi bi-check-lg me-2"></i>Randevu Oluştur
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Geri Dön
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-info-circle me-2"></i>Randevu Bilgileri
                    </h5>
                    <div id="appointmentSummary">
                        <p class="text-muted">Randevu detayları seçimlerinize göre burada görünecektir.</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="mb-3"><i class="bi bi-lightbulb text-warning me-2"></i>İpuçları</h6>
                    <ul class="list-unstyled text-muted small mb-0">
                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Randevunuzu en az 1 gün önceden alın</li>
                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>İptal için 24 saat önceden bildirim yapın</li>
                        <li class="mb-2"><i class="bi bi-check text-success me-2"></i>Randevunuz onaylandığında bildirim alacaksınız</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            let selectedService = null;
            
            // Antrenör seçildiğinde hizmetleri filtrele
            $('#trainerSelect').change(function() {
                const trainerId = $(this).val();
                if (trainerId) {
                    $.get('/Appointment/GetServicesByTrainer', { trainerId: trainerId }, function(data) {
                        $('#serviceSelect').empty().append('<option value="">-- Hizmet Seçin --</option>');
                        data.forEach(function(service) {
                            $('#serviceSelect').append(
                                `<option value="${service.id}" data-price="${service.price}" data-duration="${service.durationMinutes}">${service.name} - ${service.price} TL</option>`
                            );
                        });
                    });
                }
                updateAvailableTimes();
            });
            
            // Hizmet seçildiğinde bilgileri güncelle
            $('#serviceSelect').change(function() {
                const selected = $(this).find(':selected');
                if (selected.val()) {
                    selectedService = {
                        name: selected.text().split(' - ')[0],
                        price: selected.data('price'),
                        duration: selected.data('duration')
                    };
                    $('#serviceInfo').html(`<i class="bi bi-clock me-1"></i>${selectedService.duration} dakika`);
                }
                updateAvailableTimes();
                updateSummary();
            });
            
            // Tarih seçildiğinde müsait saatleri getir
            $('#dateSelect').change(function() {
                updateAvailableTimes();
            });
            
            // Saat seçildiğinde özeti güncelle
            $('#timeSelect').change(function() {
                updateSummary();
                validateForm();
            });
            
            function updateAvailableTimes() {
                const trainerId = $('#trainerSelect').val();
                const serviceId = $('#serviceSelect').val();
                const date = $('#dateSelect').val();
                
                if (trainerId && serviceId && date) {
                    $.get('/Appointment/GetAvailableTimes', {
                        trainerId: trainerId,
                        serviceId: serviceId,
                        date: date
                    }, function(times) {
                        $('#timeSelect').empty();
                        if (times.length > 0) {
                            $('#timeSelect').append('<option value="">-- Saat Seçin --</option>');
                            times.forEach(function(time) {
                                $('#timeSelect').append(`<option value="${time}">${time}</option>`);
                            });
                        } else {
                            $('#timeSelect').append('<option value="">Müsait saat bulunamadı</option>');
                        }
                        validateForm();
                    });
                } else {
                    $('#timeSelect').empty().append('<option value="">-- Önce tarih ve antrenör seçin --</option>');
                    validateForm();
                }
            }
            
            function updateSummary() {
                const trainerText = $('#trainerSelect option:selected').text();
                const serviceText = selectedService ? selectedService.name : '';
                const date = $('#dateSelect').val();
                const time = $('#timeSelect').val();
                
                if (trainerText !== '-- Antrenör Seçin --' && serviceText && date && time) {
                    const formattedDate = new Date(date).toLocaleDateString('tr-TR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    $('#appointmentSummary').html(`
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><strong>Antrenör:</strong> ${trainerText}</li>
                            <li class="mb-2"><strong>Hizmet:</strong> ${serviceText}</li>
                            <li class="mb-2"><strong>Tarih:</strong> ${formattedDate}</li>
                            <li class="mb-2"><strong>Saat:</strong> ${time}</li>
                            <li class="mb-2"><strong>Süre:</strong> ${selectedService.duration} dakika</li>
                            <li class="mt-3 pt-3 border-top"><strong class="text-danger fs-5">Ücret: ${selectedService.price} TL</strong></li>
                        </ul>
                    `);
                } else {
                    $('#appointmentSummary').html('<p class="text-muted">Randevu detayları seçimlerinize göre burada görünecektir.</p>');
                }
            }
            
            function validateForm() {
                const trainerId = $('#trainerSelect').val();
                const serviceId = $('#serviceSelect').val();
                const date = $('#dateSelect').val();
                const time = $('#timeSelect').val();
                
                $('#submitBtn').prop('disabled', !(trainerId && serviceId && date && time));
            }
        });
    </script>
}



